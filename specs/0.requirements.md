# aki-gsub Functional Requirements

## 1. Core Functionality

- The primary function of `aki-gsub` is to perform text substitution on an input stream using regular expressions.
- It reads from standard input, applies one or more regex-based replacements, and writes the result to standard output.

## 2. Input Handling

- The tool shall read text line-by-line from standard input.
- If no match is found in a line, the original line shall be printed to standard output, unless the `--quiet` option is specified.

## 3. Output Handling

- The modified text shall be written to standard output.
- The tool shall support highlighting matched and substituted text using ANSI color codes.
- The tool shall handle broken pipe errors gracefully (e.g., when piping output to `head`).

## 4. Command-Line Arguments & Options

The tool must implement the following command-line arguments:

| Short | Long      | Parameter | Description                                         | Behavior                                                                                             |
| :---- | :-------- | :-------- | :-------------------------------------------------- | :--------------------------------------------------------------------------------------------------- |
| `-e`  | `--exp`   | `<exp>`   | Specifies the regular expression to search for.     | This option is mandatory. Can be specified multiple times. Each `-e` must have a corresponding `-f`. |
| `-f`  | `--format`| `<fmt>`   | Specifies the replacement format string.            | This option is mandatory. Can be specified multiple times. Supports capture group references like `$1`, `$2`. |
|       | `--color` | `<when>`  | Controls when to use color for highlighting.        | `<when>` can be `always`, `never`, or `auto`. In `auto` mode, color is enabled only if stdout is a TTY. |
| `-n`  | `--quiet` |           | Suppress output of lines that do not match.         | If set, only lines with successful substitutions are printed.                                        |
| `-H`  | `--help`  |           | Display the help message.                           | Prints a detailed help message and exits.                                                            |
| `-V`  | `--version`|           | Display version information.                        | Prints the application name and version and exits.                                                   |
| `-X`  |           | `<param>` | An extensible, "unstable" option for special tasks. | Used for developer/debugging features like `rust-version-info`.                                      |

## 5. Substitution Logic

- The tool must support multiple `-e`/`-f` pairs. All expressions are applied to each line.
- The replacement format (`-f`) shall support capture groups from the corresponding expression (`-e`) using `$0`, `$1`, `$2`, etc.
- If multiple matches occur (from the same or different expressions), they are applied based on their starting position in the original line.

## 6. Environment Variables

- `AKI_GSUB_COLOR_SEQ_ST`: Overrides the default ANSI escape code for the start of a colorized highlight.
- `AKI_GSUB_COLOR_SEQ_ED`: Overrides the default ANSI escape code for the end of a colorized highlight.

## 7. Error Handling

- The tool shall exit with a non-zero status code on error.
- It must provide clear error messages, for instance, if `-e` and `-f` options are not paired correctly.
- It shall print a "Try --help for help." message on argument parsing errors.
